## TCP和UDP的区别

UDP它是无连接的数据报协议：使用UDP进行数据报传输的不需要建立连接，直接根据目标的ip和端口在网络上进行传输，所以他不保证可靠传输，但也正是因为无需建立连接，所以传输的时延很小。还有就是UDP不合适大文件的传输，因为万一传输过程中丢失，进行重传的代价是比较大的

TCP它是有连接的数据传输协议：使用TCP进行传输时，要经过三次挥手来建立连接，可以实现全双工通信，这也导致了TCP它的传输延时较高。相比于UDP，它提供了一系列的机制来保证了数据的可靠传输，所以，它适合用于一些大文件的传输。

## TCP如何保证可靠传输

主要通过TCP校验、序列号、确认号、重传机制来保证可靠传输

TCP校验：不同于IP报文段的校验，TCP会针对整个数据报校验，在报文段发送之前 加上伪首部，通过对伪首部、首部、数据部分进行二进制求和后，将结果取反填入校验和字段，再去掉伪首部进行发送，接收端接受后采取同样的方式进行验证，若是求和结果全为1则说明传输过程中没有发生差错。

序列号：TCP它是面向字节流传输的，每次传输的报文段中都会将报文段中的第一个字节对应的序号作为此次报文段的序列号，接收端接收到报文段后，会根据序列号来对报文段进行排序，保证报文段的有序性。

确认号：接收方通过像发送方发送确认号来通知自己已经接收到了确认好之前的数据，并期望下一次收到的报文段的序列号

重传机制：若是报文段再传输的过程中，因为网络拥塞，或是在路由节点中进行传输时发生了超时、丢失、出现差错的话，发送方就会对该报文段进行重传。

TCP就是通过以上机制来实现可靠传输的。

## TCP流量控制

关注端到端，主机之间的负载

TCP流量控制主要是通过滑动窗口机制来对发送方进行流量控制。

接收方会将自己的接收窗口的大小填充到窗口字段中，发送方接收到后，会在接收方的窗口大小和网络上的拥塞窗口之间取较小值作为自己的发送窗口的大小，通过动态的改变发送方的窗口大小来进行流量控制。当接收方不再接收数据时，会对发送方发送一个0窗口通知，发送方收到一个就停止发送，并维护一个计时器，隔一段时间对接受方的窗口进行探测。

## TCP拥塞控制

关注整个网络上的负载（所有主机之间，路由器之间）

​	**首先执行慢开始算法**，将拥塞窗口值设置为1，每收到一个新报文段的确认后，将拥塞窗口值进行指数级的增长，直到拥塞窗口值达到慢开始门限后，**采用拥塞避免算法**，也就是开始加法增大，每收到一个确认后，将拥塞窗口值加1，直到网络出现拥塞，此时将拥塞窗口之除2作为新的慢开始门限，并且直接将拥塞窗口值降为1，重新开始慢开始算法。

后来有引入了**快重传和快恢复**算法进行了优化。

快重传就是提前预知网络的拥塞情况，不用等到发送方出现超时才进行重传，而是再发送方收到三个冗余的ACK确认后，就开始进行重传；快恢复就是当出现网络拥塞时，不用讲拥塞窗口值直接降为1，而是将拥塞窗口的值设置为慢开始门限改变后的值，然后继续进行拥塞避免算法，加法增大。

## 为什么TCP不能两次握手？

主要是为了防止服务端收到无效的TCP连接请求造成的一些错误。比如客户A第一次向服务器B发送了TCP连接请求，但由于网络拥塞，服务器迟迟没有收到，这时客户端没有收到服务器的ACK确认后会进行重发，服务器B收到第二次的TCP连接请求后，对客户端进行恢复确认建立连接，数据传输完后断开连接，此时第一次的TCP请求到达，这时如果采用两次握手的话，服务器恢复客户端确认，但客户端会认为是一个无效的恢复，将确认报文段丢弃，此时服务器会在很长一段时间内一直保持这个无效连接，造成系统资源的浪费。

## TCP的time_wait状态

time_wait状态是在tcp四次挥手的过程中第四次之后，主动关闭方要等待2MSL后才关闭连接，原因有两点：

1、确保第四次挥手发送的报文段能被接收方接受，若是最后一次报文段在传输的过程中丢失，那么发送方还能接收到接收方重传的FIN报文段，这时发送方就能对丢失的报文段重传。

2、防止具有相同四元组的旧数据包被收到，也就是防止历史连接中的数据，被后面的连接接受，否则就会导致后面的连接收到一个无效的数据



> 注：
>
> 在 TCP 三次握手的时候，Linux 内核会维护两个队列，分别是：
>
> - 半连接队列，也称 SYN 队列；
> - 全连接队列，也称 accepet 队列；
>
> 服务端收到客户端发起的 SYN 请求后，**内核会把该连接存储到半连接队列**，并向客户端响应 SYN+ACK，接着客户端会返回 ACK，服务端收到第三次握手的 ACK 后，**内核会把连接从半连接队列移除，然后创建新的完全的连接，并将其添加到 accept 队列，等待进程调用 accept 函数时把连接取出来。**



> SYN 报文什么时候情况下会被丢弃？
>
> https://cloud.tencent.com/developer/article/1925531
